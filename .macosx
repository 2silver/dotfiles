#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# Thanks to Mathias Bynens!
# ~/.macos — https://mths.be/macos

###############################################################################
# Helpers / Guards                                                            #
###############################################################################

log()  { printf '%s\n' "$*"; }
warn() { printf 'WARN: %s\n' "$*" >&2; }

has_cmd() { command -v "$1" >/dev/null 2>&1; }
has_app() { [[ -d "/Applications/$1.app" ]] || [[ -d "$HOME/Applications/$1.app" ]]; }

# Best-effort defaults write (won't fail the whole script on a single key)
dwrite() {
  local domain="$1"; shift
  if ! defaults write "$domain" "$@" >/dev/null 2>&1; then
    warn "defaults write failed: domain=$domain args=[$*]"
    return 0
  fi
}

ddelete() {
  local domain="$1"; shift
  defaults delete "$domain" "$@" >/dev/null 2>&1 || true
}

kill_if_running() {
  local proc="$1"
  killall "$proc" >/dev/null 2>&1 || true
}

###############################################################################
# Start                                                                        #
###############################################################################

log "We will ask for your Administrator password... (Wait for 3s)"
sleep 3

# Close System Settings / System Preferences (both, for compatibility)
osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
osascript -e 'tell application "System Preferences" to quit' 2>/dev/null || true

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing sudo timestamp until script has finished
( while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done ) 2>/dev/null &
SUDO_KEEPALIVE_PID=$!
trap 'kill "$SUDO_KEEPALIVE_PID" >/dev/null 2>&1 || true' EXIT

###############################################################################
# General UI/UX                                                               #
###############################################################################

# Set computer name (as done via System Settings → General → About)
sudo scutil --set ComputerName "macnscgraf" || true
sudo scutil --set HostName "macnscgraf" || true
sudo scutil --set LocalHostName "macnscgraf" || true
sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.smb.server NetBIOSName -string "macnscgraf" || true

# Disable the sound effects on boot (modern nvram key)
sudo nvram StartupMute=%01 || true

# Highlight color: delete -> default (blue)
ddelete -g AppleHighlightColor

# Sidebar icon size: 1=small, 2=medium, 3=large
dwrite NSGlobalDomain NSTableViewDefaultSizeMode -int 2

# Always show scrollbars
dwrite NSGlobalDomain AppleShowScrollBars -string "Always"

# Increase window resize speed for Cocoa applications
dwrite NSGlobalDomain NSWindowResizeTime -float 0.001

# Expand save panel by default
dwrite NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
dwrite NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true

# Expand print panel by default
dwrite NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
dwrite NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Save to disk (not to iCloud) by default
dwrite NSGlobalDomain NSDocumentSaveNewDocumentsToCloud -bool false

# Automatically quit printer app once print jobs complete
dwrite com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# Remove duplicates in the “Open With” menu (guarded)
if [[ -x "/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister" ]]; then
  /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister \
    -kill -r -domain local -domain system -domain user || true
fi

# Display ASCII control characters using caret notation in standard text views
dwrite NSGlobalDomain NSTextShowsControlCharacters -bool true

# Set Help Viewer windows to non-floating mode
dwrite com.apple.helpviewer DevMode -bool true

# Reveal hostname etc. in login window clock
sudo defaults write /Library/Preferences/com.apple.loginwindow AdminHostInfo HostName || true

# Never go into computer sleep mode (AC + Battery)
sudo systemsetup -setsleep off >/dev/null 2>&1 || true

# Disable smart quotes/dashes (coding-friendly)
dwrite NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
dwrite NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

# Toolbar title rollover delay (icon/time)
dwrite NSGlobalDomain NSToolbarTitleViewRolloverDelay -float 0.5

###############################################################################
# SSD-specific tweaks                                                         #
###############################################################################

# Note: Local Time Machine snapshots are automatically managed in macOS 11+
# (tmutil disablelocal was removed)

# Sudden motion sensor (mostly legacy hardware; harmless if unsupported)
sudo pmset -a sms 0 >/dev/null 2>&1 || true

###############################################################################
# Mouse / Trackpad / Keyboard                                                 #
###############################################################################

# Disable “natural” scrolling
dwrite NSGlobalDomain com.apple.swipescrolldirection -bool false

# Enable full keyboard access for all controls (Tab in dialogs, etc.)
dwrite NSGlobalDomain AppleKeyboardUIMode -int 3

# Disable press-and-hold for keys in favor of key repeat
dwrite NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Keyboard repeat
dwrite NSGlobalDomain InitialKeyRepeat -int 10
dwrite NSGlobalDomain KeyRepeat -int 3

# Language and locale
dwrite NSGlobalDomain AppleLanguages -array "de" "en"
dwrite NSGlobalDomain AppleLocale -string "de_AT@currency=EUR"
dwrite NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
dwrite NSGlobalDomain AppleMetricUnits -bool true

# Timezone
sudo systemsetup -settimezone "Europe/Vienna" >/dev/null 2>&1 || true

# Disable auto-correct
dwrite NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

###############################################################################
# Energy saving                                                               #
###############################################################################

sudo pmset -a lidwake 1 >/dev/null 2>&1 || true
sudo pmset -a autorestart 1 >/dev/null 2>&1 || true
sudo systemsetup -setrestartfreeze on >/dev/null 2>&1 || true
sudo pmset -a displaysleep 15 >/dev/null 2>&1 || true
sudo pmset -c sleep 0 >/dev/null 2>&1 || true
sudo pmset -b sleep 20 >/dev/null 2>&1 || true
sudo pmset -a standbydelay 86400 >/dev/null 2>&1 || true

###############################################################################
# Screenshots                                                                 #
###############################################################################

# Save screenshots to Desktop
dwrite com.apple.screencapture location -string "${HOME}/Desktop"

# Use PNG format
dwrite com.apple.screencapture type -string "png"

# Without shadow
dwrite com.apple.screencapture disable-shadow -bool true

# Filename includes date
dwrite com.apple.screencapture include-date -bool true

# Show thumbnail after capture
dwrite com.apple.screencapture show-thumbnail -bool true

kill_if_running "SystemUIServer"

###############################################################################
# Finder                                                                      #
###############################################################################

# Do not show Finder "Quit" (keep Finder always running)
dwrite com.apple.finder QuitMenuItem -bool false

# Show all filename extensions
dwrite NSGlobalDomain AppleShowAllExtensions -bool true

# Show hidden files = false
dwrite com.apple.finder AppleShowAllFiles -bool false

# Show path bar
dwrite com.apple.finder ShowPathbar -bool true

# Use list view by default
dwrite com.apple.finder FXPreferredViewStyle -string "Nlsv"

# Folders on top (in windows + desktop)
dwrite com.apple.finder _FXSortFoldersFirst -bool true
dwrite com.apple.finder _FXSortFoldersFirstOnDesktop -bool true

# Open folders in tabs
dwrite com.apple.finder FinderSpawnTab -bool true

# Search scope: current folder
dwrite com.apple.finder FXDefaultSearchScope -string "SCcf"

# Empty trash after 30 days
dwrite com.apple.finder FXRemoveOldTrashItems -bool true

# File-extension warning = true
dwrite com.apple.finder FXEnableExtensionChangeWarning -bool true

# Avoid creating .DS_Store on network/USB
dwrite com.apple.desktopservices DSDontWriteNetworkStores -bool true
dwrite com.apple.desktopservices DSDontWriteUSBStores -bool true

# Desktop icons / disks / servers
dwrite com.apple.finder CreateDesktop -bool true
dwrite com.apple.finder ShowHardDrivesOnDesktop -bool true
dwrite com.apple.finder ShowExternalHardDrivesOnDesktop -bool true
dwrite com.apple.finder ShowRemovableMediaOnDesktop -bool true
dwrite com.apple.finder ShowMountedServersOnDesktop -bool true

# Show the ~/Library folder
chflags nohidden "${HOME}/Library" >/dev/null 2>&1 || true

# Optional: Finder plist tweaks via PlistBuddy (guarded, best-effort)
if has_cmd /usr/libexec/PlistBuddy && [[ -f "${HOME}/Library/Preferences/com.apple.finder.plist" ]]; then
  /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:showItemInfo true" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:showItemInfo true" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:showItemInfo true" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy grid" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy grid" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy grid" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:gridSpacing 100" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:gridSpacing 100" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:gridSpacing 100" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:iconSize 52" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:iconSize 52" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
  /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:iconSize 52" "${HOME}/Library/Preferences/com.apple.finder.plist" >/dev/null 2>&1 || true
fi

# for now, we haven't dropbox installed
# Dropbox icon hack (guarded)
# DROPBOX_ICON="/Applications/Dropbox.app/Contents/Resources/emblem-dropbox-uptodate.icns"
#[[ -e "${DROPBOX_ICON}" ]] && mv -f "${DROPBOX_ICON}" "${DROPBOX_ICON}.bak" || true

# Expand File Info panes
dwrite com.apple.finder FXInfoPanesExpanded -dict \
  General -bool true \
  OpenWith -bool true \
  Privileges -bool true

kill_if_running "Finder"

###############################################################################
# Dock                                                                        #
###############################################################################

# Dock position
dwrite com.apple.dock orientation -string "bottom"

# Icon size
dwrite com.apple.dock tilesize -int 36

# Autohide = false
dwrite com.apple.dock autohide -bool false

# Show recent apps = false
dwrite com.apple.dock show-recents -bool false

# Only show open apps = false
dwrite com.apple.dock static-only -bool false

# Scroll on dock icon to show open windows = true
dwrite com.apple.dock scroll-to-open -bool true

# (Keeping your existing quality-of-life defaults)
dwrite com.apple.dock mouse-over-hilite-stack -bool true
dwrite com.apple.dock mineffect -string "scale"
dwrite com.apple.dock minimize-to-application -bool true
dwrite com.apple.dock enable-spring-load-actions-on-all-items -bool true
dwrite com.apple.dock show-process-indicators -bool true
dwrite com.apple.dock launchanim -bool false
dwrite com.apple.dock expose-animation-duration -float 0.1
dwrite com.apple.dock expose-group-by-app -bool false
dwrite com.apple.dock mru-spaces -bool false
dwrite com.apple.dock autohide-delay -float 0
dwrite com.apple.dock autohide-time-modifier -float 0
dwrite com.apple.dock showhidden -bool true

# Optional: wipe default persistent apps (commented in your original; keep off by default)
# dwrite com.apple.dock persistent-apps -array

# Reset Launchpad (guarded)
find "${HOME}/Library/Application Support/Dock" -maxdepth 1 -name "*-*.db" -delete 2>/dev/null || true

# for now, not installed
# Add iOS Simulator to /Applications (guarded)
# if [[ -d "/Applications/Xcode.app/Contents/Developer/Applications/iOS Simulator.app" ]]; then
#   sudo ln -sf "/Applications/Xcode.app/Contents/Developer/Applications/iOS Simulator.app" "/Applications/iOS Simulator.app" || true
# fi

kill_if_running "Dock"

###############################################################################
# Hot corners                                                                 #
###############################################################################
dwrite com.apple.dock wvous-tl-corner -int 0
dwrite com.apple.dock wvous-tl-modifier -int 0
dwrite com.apple.dock wvous-tr-corner -int 0
dwrite com.apple.dock wvous-tr-modifier -int 0
dwrite com.apple.dock wvous-bl-corner -int 0
dwrite com.apple.dock wvous-bl-modifier -int 0

###############################################################################
# Menu Bar                                                                    #
###############################################################################

# Flash date separators in clock (guarded)
dwrite com.apple.menuextra.clock FlashDateSeparators -bool true
kill_if_running "SystemUIServer"

###############################################################################
# Safari & WebKit                                                             #
###############################################################################

dwrite com.apple.Safari UniversalSearchEnabled -bool false
dwrite com.apple.Safari SuppressSearchSuggestions -bool true
dwrite com.apple.Safari WebKitTabToLinksPreferenceKey -bool true
dwrite com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2TabsToLinks -bool true
dwrite com.apple.Safari ShowFullURLInSmartSearchField -bool true
dwrite com.apple.Safari HomePage -string "about:blank"
dwrite com.apple.Safari AutoOpenSafeDownloads -bool false
dwrite com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2BackspaceKeyNavigationEnabled -bool true
dwrite com.apple.Safari ShowFavoritesBar -bool false
dwrite com.apple.Safari ShowSidebarInTopSites -bool false
dwrite com.apple.Safari DebugSnapshotsUpdatePolicy -int 2
dwrite com.apple.Safari IncludeInternalDebugMenu -bool true
dwrite com.apple.Safari FindOnPageMatchesWordStartsOnly -bool false
dwrite com.apple.Safari ProxiesInBookmarksBar "()"
dwrite com.apple.Safari IncludeDevelopMenu -bool true
dwrite com.apple.Safari WebKitDeveloperExtrasEnabledPreferenceKey -bool true
dwrite com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled -bool true
dwrite NSGlobalDomain WebKitDeveloperExtras -bool true
dwrite com.apple.Safari WarnAboutFraudulentWebsites -bool true

# Disable auto-playing video (guard STP domain)
dwrite com.apple.Safari WebKitMediaPlaybackAllowsInline -bool false
dwrite com.apple.Safari com.apple.Safari.ContentPageGroupIdentifier.WebKit2AllowsInlineMediaPlayback -bool false
if defaults read com.apple.SafariTechnologyPreview >/dev/null 2>&1; then
  dwrite com.apple.SafariTechnologyPreview WebKitMediaPlaybackAllowsInline -bool false
  dwrite com.apple.SafariTechnologyPreview com.apple.Safari.ContentPageGroupIdentifier.WebKit2AllowsInlineMediaPlayback -bool false
fi

dwrite com.apple.Safari SendDoNotTrackHTTPHeader -bool true
dwrite com.apple.Safari InstallExtensionUpdatesAutomatically -bool true

###############################################################################
# Mail                                                                        #
###############################################################################

dwrite com.apple.mail DisableReplyAnimations -bool true
dwrite com.apple.mail DisableSendAnimations -bool true
dwrite com.apple.mail AddressesIncludeNameOnPasteboard -bool false
dwrite com.apple.mail NSUserKeyEquivalents -dict-add "Send" -string "@\\U21a9"
dwrite com.apple.mail DraftsViewerAttributes -dict-add "DisplayInThreadedMode" -string "yes"
dwrite com.apple.mail DraftsViewerAttributes -dict-add "SortedDescending" -string "yes"
dwrite com.apple.mail DraftsViewerAttributes -dict-add "SortOrder" -string "received-date"
dwrite com.apple.mail DisableInlineAttachmentViewing -bool true
dwrite com.apple.mail SpellCheckingBehavior -string "NoSpellCheckingEnabled"

###############################################################################
# Spotlight                                                                   #
###############################################################################

# (Modern Spotlight may ignore some preference tweaks; keep only index rebuild)
killall mds >/dev/null 2>&1 || true
sudo mdutil -i on / >/dev/null 2>&1 || true
sudo mdutil -E / >/dev/null 2>&1 || true

###############################################################################
# Terminal & iTerm 2                                                          #
###############################################################################

dwrite com.apple.terminal StringEncodings -array 4

# iTerm: only if installed
if has_app "iTerm"; then
  dwrite com.googlecode.iterm2 PrefsCustomFolder -string "${HOME}/.dotfiles/init/iterm"
  dwrite com.googlecode.iterm2 PromptOnQuit -bool false

  THEME_FILE="${HOME}/.dotfiles/init/iterm/Solarized Dark - Patched.itermcolors"
  [[ -f "${THEME_FILE}" ]] && open "${THEME_FILE}" || true
fi

###############################################################################
# Time Machine                                                                #
###############################################################################

dwrite com.apple.TimeMachine DoNotOfferNewDisksForBackup -bool true

###############################################################################
# Activity Monitor                                                            #
###############################################################################

dwrite com.apple.ActivityMonitor OpenMainWindow -bool true
dwrite com.apple.ActivityMonitor IconType -int 5
dwrite com.apple.ActivityMonitor ShowCategory -int 0
dwrite com.apple.ActivityMonitor SortColumn -string "CPUUsage"
dwrite com.apple.ActivityMonitor SortDirection -int 0

###############################################################################
# TextEdit / Disk Utility                                                     #
###############################################################################

dwrite com.apple.TextEdit RichText -int 0
dwrite com.apple.TextEdit PlainTextEncoding -int 4
dwrite com.apple.TextEdit PlainTextEncodingForWrite -int 4

dwrite com.apple.DiskUtility DUDebugMenuEnabled -bool true
dwrite com.apple.DiskUtility advanced-image-options -bool true

###############################################################################
# Mac App Store / Software Update                                             #
###############################################################################

dwrite com.apple.appstore WebKitDeveloperExtras -bool true
dwrite com.apple.appstore ShowDebugMenu -bool true
dwrite com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true
dwrite com.apple.SoftwareUpdate ScheduleFrequency -int 1
dwrite com.apple.SoftwareUpdate AutomaticDownload -int 1
dwrite com.apple.SoftwareUpdate CriticalUpdateInstall -int 1
dwrite com.apple.commerce AutoUpdate -bool true

###############################################################################
# Messages                                                                    #
###############################################################################

dwrite com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "automaticEmojiSubstitutionEnablediMessage" -bool false
dwrite com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "automaticQuoteSubstitutionEnabled" -bool false
dwrite com.apple.messageshelper.MessageController SOInputLineSettings -dict-add "continuousSpellCheckingEnabled" -bool false

###############################################################################
# Google Chrome                                                               #
###############################################################################

# Only apply if domains exist (Chrome Canary might not be installed)
if defaults read com.google.Chrome >/dev/null 2>&1; then
  dwrite com.google.Chrome DisablePrintPreview -bool true
  dwrite com.google.Chrome PMPrintingExpandedStateForPrint2 -bool true
fi
if defaults read com.google.Chrome.canary >/dev/null 2>&1; then
  dwrite com.google.Chrome.canary DisablePrintPreview -bool true
  dwrite com.google.Chrome.canary PMPrintingExpandedStateForPrint2 -bool true
fi

###############################################################################
# Photos                                                                      #
###############################################################################

# Deactivate Photos auto-start on camera/USB plugin
dwrite -currentHost com.apple.ImageCapture disableHotPlug -bool true

###############################################################################
# Kill affected applications                                                  #
###############################################################################

log "Done. Note that some of these changes require a logout/restart to take effect. (Wait for 3s)"
sleep 3

for app in \
  "Activity Monitor" \
  "Address Book" \
  "Calendar" \
  "Contacts" \
  "cfprefsd" \
  "Dock" \
  "Finder" \
  "Google Chrome" \
  "Google Chrome Canary" \
  "Mail" \
  "Messages" \
  "Opera" \
  "Photos" \
  "Safari" \
  "SystemUIServer" \
  "Terminal" \
  "iTerm" \
  "iCal"; do
  killall "${app}" >/dev/null 2>&1 || true
done
